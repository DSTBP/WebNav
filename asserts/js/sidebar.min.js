// sidebar.min.js
// 视觉优化版：高对比度配色（日间深色/夜间亮色），解决看不清的问题，保持简约形状
(function() {
    // 1. 创建状态球按钮 (简约箭头图标)
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'sidebar-toggle-btn';
    toggleBtn.type = 'button';
    toggleBtn.title = '展开菜单';
    toggleBtn.innerHTML = `
        <span class="visually-hidden">展开侧边栏</span>
        <svg class="sidebar-toggle__icon" viewBox="0 0 24 24" role="img" aria-hidden="true">
            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path>
        </svg>
    `;
    document.body.appendChild(toggleBtn);

    // 2. 创建侧边栏容器
    const sidebar = document.createElement('nav');
    sidebar.id = 'custom-sidebar';
    sidebar.innerHTML = '<ul id="sidebar-menu"></ul>';
    document.body.appendChild(sidebar);

    // 3. 样式注入
    const style = document.createElement('style');
    style.textContent = `
    /* 按钮样式 - 高对比度半胶囊设计 */
    #sidebar-toggle-btn {
        position: fixed;
        top: 50%;
        left: 0;
        z-index: 10000;
        width: 28px;
        height: 64px;
        padding: 0;
        
        /* 形状：右侧圆润 */
        border-radius: 0 12px 12px 0;
        border: none;
        
        /* 【关键修改】颜色：日间模式使用深色主题色，确保高对比度 */
        background: var(--primary-color, #2c3e50);
        
        /* 阴影：增加立体感 */
        box-shadow: 2px 2px 8px rgba(44, 62, 80, 0.3);
        
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        
        /* 性能优化 */
        transform: translate3d(0, -50%, 0);
        will-change: transform; 
        transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1), 
                    background-color 0.3s, 
                    box-shadow 0.3s,
                    width 0.2s;
    }
    
    /* 悬停效果：稍微变宽 */
    #sidebar-toggle-btn:hover {
        width: 36px;
        /* 悬停时稍微变亮或加深，视主题而定，这里保持原色但加重阴影 */
        box-shadow: 4px 4px 12px rgba(44, 62, 80, 0.4);
    }

    /* 按钮图标：日间模式为白色 */
    #sidebar-toggle-btn .sidebar-toggle__icon {
        width: 24px;
        height: 24px;
        fill: #ffffff; /* 白色图标 */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #sidebar-toggle-btn:hover .sidebar-toggle__icon {
        transform: scale(1.1);
    }
    
    /* 展开状态：箭头旋转180度 */
    #sidebar-toggle-btn.sidebar-open .sidebar-toggle__icon {
        transform: rotate(180deg);
    }

    /* 侧边栏基础样式 */
    #custom-sidebar {
        position: fixed;
        top: 50%;
        left: 0;
        z-index: 9999;
        background: var(--bg-white, rgba(255, 255, 255, 0.95));
        box-shadow: var(--shadow-lg);
        border-radius: 22px;
        padding: 20px 0;
        
        min-width: 72px;
        max-width: 180px;
        width: auto;
        
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid var(--border-light);
        
        /* 默认隐藏 */
        transform: translate3d(calc(-100% - 20px), -50%, 0);
        will-change: transform;
        transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
    }

    /* 展开状态 */
    #custom-sidebar.sidebar-open {
        transform: translate3d(20px, -50%, 0);
    }

    /* 菜单列表 */
    #custom-sidebar ul {
        list-style: none;
        margin: 0;
        padding: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #custom-sidebar li {
        width: 100%;
        margin-bottom: 8px;
        display: flex;
        justify-content: center;
    }

    /* 菜单链接 */
    #custom-sidebar a {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: calc(100% - 12px);
        min-width: 80px; 
        padding: 12px 0;
        border-radius: 16px;
        color: var(--text-primary);
        text-decoration: none;
        transition: background 0.2s, color 0.2s, transform 0.1s;
    }

    #custom-sidebar a i {
        font-size: 2.1rem; 
        margin-bottom: 4px;
        transition: transform 0.2s;
    }
    
    #custom-sidebar a span {
        font-size: 1.5rem; 
        font-weight: 500;
        margin-top: 2px;
    }

    #custom-sidebar a:hover {
        background: var(--primary-gradient);
        color: #fff;
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    #custom-sidebar a:hover i,
    #custom-sidebar a:hover span {
        color: #fff;
    }

    /* ========== 暗色模式适配 (关键修改) ========== */
    
    /* 按钮：夜间模式改为亮白色，确保在深色背景下清晰可见 */
    body[data-theme="dark"] #sidebar-toggle-btn {
        background: #e0e0e0; /* 亮灰白 */
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
    }
    
    body[data-theme="dark"] #sidebar-toggle-btn:hover {
        background: #ffffff; /* 悬停变纯白 */
        box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.7);
    }
    
    /* 图标：夜间模式改为深色，与亮白按钮形成对比 */
    body[data-theme="dark"] #sidebar-toggle-btn .sidebar-toggle__icon {
        fill: #1a252f; /* 深色图标 */
    }

    /* 侧边栏本体暗色适配 */
    body[data-theme="dark"] #custom-sidebar {
        /* 修改：与 app.css 统一，使用中性灰，去除蓝黑调 */
        background: rgba(65, 65, 65, 0.85);
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    body[data-theme="dark"] #custom-sidebar a {
        color: #a3afc3;
    }
    
    body[data-theme="dark"] #custom-sidebar a:hover {
        color: #fff;
    }
    `;
    document.head.appendChild(style);

    // 4. 读取数据
    function initSidebarMenu() {
        const data = window.NAV_DATA; // 直接获取数据
        if (!data) {
            console.warn('Sidebar: 未找到 window.NAV_DATA，请确保 data.js 已加载');
            return;
        }

        const menu = data['main-menu'];
        const ul = document.getElementById('sidebar-menu');
        if (menu && ul) {
            // 清空旧内容（防止重复）
            ul.innerHTML = ''; 
            Object.values(menu).forEach(item => {
                const li = document.createElement('li');
                // 这里保持原本的逻辑
                li.innerHTML = `<a href="${item.href}"><i class="${item.icon}"></i><span>${item.title}</span></a>`;
                ul.appendChild(li);
            });
        }
    }

    // 尝试初始化，如果 data.js 在此脚本之后加载，可能需要等待
    if (window.NAV_DATA) {
        initSidebarMenu();
    } else {
        // 如果数据还没准备好，监听一个自定义事件或者稍微延时（简单的处理方式）
        window.addEventListener('load', initSidebarMenu);
    }

    // 5. 逻辑控制
    let sidebarVisible = false;
    let cachedSidebarWidth = 0;

    function updateSidebarWidth() {
        const sidebar = document.getElementById('custom-sidebar');
        cachedSidebarWidth = sidebar.offsetWidth;
    }

    function toggleSidebar() {
        sidebarVisible = !sidebarVisible;
        const sidebar = document.getElementById('custom-sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        
        if (!cachedSidebarWidth) {
            updateSidebarWidth();
        }

        if (sidebarVisible) {
            sidebar.classList.add('sidebar-open');
            toggleBtn.classList.add('sidebar-open');
            // 按钮移动位置：侧边栏宽度 + 20px间距 + 8px缝隙
            const moveX = cachedSidebarWidth + 20 + 8; 
            toggleBtn.style.transform = `translate3d(${moveX}px, -50%, 0)`;
        } else {
            sidebar.classList.remove('sidebar-open');
            toggleBtn.classList.remove('sidebar-open');
            toggleBtn.style.transform = `translate3d(0, -50%, 0)`;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebar = document.getElementById('custom-sidebar');

        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });

        document.addEventListener('click', function(e) {
            if (sidebarVisible && 
                !sidebar.contains(e.target) && 
                !toggleBtn.contains(e.target)) {
                toggleSidebar();
            }
        });
        
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                updateSidebarWidth();
                if (sidebarVisible) {
                    const toggleBtn = document.getElementById('sidebar-toggle-btn');
                    const moveX = cachedSidebarWidth + 20 + 8;
                    toggleBtn.style.transform = `translate3d(${moveX}px, -50%, 0)`;
                }
            }, 200);
        });
    });
})();