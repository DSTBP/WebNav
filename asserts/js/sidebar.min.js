// sidebar.min.js
// 性能优化版：使用 Transform 代替 Left 动画，移除强制回流
(function() {
    // 1. 创建状态球按钮
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'sidebar-toggle-btn';
    toggleBtn.type = 'button';
    toggleBtn.title = '展开菜单';
    toggleBtn.innerHTML = `
        <span class="visually-hidden">展开侧边栏</span>
        <svg class="sidebar-toggle__icon" viewBox="0 0 24 24" role="img" aria-hidden="true">
            <path d="M6 7h12v2H6V7zm0 4h12v2H6v-2zm0 4h12v2H6v-2z"></path>
        </svg>
    `;
    document.body.appendChild(toggleBtn);

    // 2. 创建侧边栏容器
    const sidebar = document.createElement('nav');
    sidebar.id = 'custom-sidebar';
    sidebar.innerHTML = '<ul id="sidebar-menu"></ul>';
    document.body.appendChild(sidebar);

    // 3. 样式注入 - 关键修改：使用 transform 并在 GPU 层渲染
    const style = document.createElement('style');
    style.textContent = `
    /* 按钮基础样式 */
    #sidebar-toggle-btn {
        position: fixed;
        top: 50%;
        left: 0;
        z-index: 10000;
        width: 40px;
        height: 92px;
        padding: 0;
        border: none;
        border-radius: 0 38px 38px 0;
        background: linear-gradient(180deg, #3b4e60, #1c2732);
        box-shadow: 2px 0 8px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        cursor: pointer;
        /* 性能优化：使用 transform 移动，开启硬件加速 */
        transform: translate3d(0, -50%, 0);
        will-change: transform; 
        transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.3s ease;
    }
    
    #sidebar-toggle-btn::after {
        content: "";
        position: absolute;
        inset: 3px 6px 3px 0;
        border-radius: 0 32px 32px 0;
        border: 1.5px solid rgba(255, 255, 255, 0.12);
        border-left: none;
        pointer-events: none;
    }

    #sidebar-toggle-btn:hover {
        /* hover 仅改变阴影，不要改变位置以免触发重排 */
        box-shadow: 4px 0 12px rgba(0,0,0,0.3);
    }

    #sidebar-toggle-btn .sidebar-toggle__icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        fill: #e6eaef;
        transition: fill 0.3s ease;
    }
    
    #sidebar-toggle-btn:hover .sidebar-toggle__icon {
        fill: #ffffff;
    }

    /* 侧边栏基础样式 */
    #custom-sidebar {
        position: fixed;
        top: 50%;
        left: 0; /* 固定在左侧，通过 transform 隐藏 */
        z-index: 9999;
        background: var(--bg-white);
        box-shadow: var(--shadow-md);
        border-radius: 22px;
        padding: 18px 0;
        min-width: 72px;
        max-width: 160px;
        width: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid var(--border-light);
        
        /* 性能优化：默认向左平移 100% + 20px 隐藏 */
        transform: translate3d(calc(-100% - 20px), -50%, 0);
        will-change: transform;
        transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        /* 移除 backdrop-filter 以提升滑动性能，如果需要可只在桌面端开启 */
        /* backdrop-filter: blur(10px); */
    }

    /* 侧边栏展开状态 */
    #custom-sidebar.sidebar-open {
        /* 回到原位 */
        transform: translate3d(20px, -50%, 0);
    }
    
    /* 按钮跟随展开状态 - 将由 JS 动态计算具体的 translateX 值 */
    #sidebar-toggle-btn.sidebar-open {
        /* 这个值会被 JS 覆盖，这里是兜底 */
        transform: translate3d(100px, -50%, 0);
    }

    /* 菜单项样式 */
    #custom-sidebar ul {
        list-style: none;
        margin: 0;
        padding: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #custom-sidebar li {
        width: 100%;
        margin-bottom: 8px;
        display: flex;
        justify-content: center;
    }

    #custom-sidebar a {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: calc(100% - 12px);
        min-width: 60px;
        padding: 10px 0;
        border-radius: 16px;
        color: var(--text-primary);
        text-decoration: none;
        transition: background 0.2s, color 0.2s, transform 0.1s;
    }

    #custom-sidebar a i {
        font-size: 1.8rem;
        margin-bottom: 4px;
        transition: transform 0.2s;
    }
    
    #custom-sidebar a span {
        font-size: 1rem;
        font-weight: 500;
    }

    #custom-sidebar a:hover {
        background: var(--primary-gradient);
        color: #fff;
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* 暗色模式适配 */
    body[data-theme="dark"] #custom-sidebar {
        background: rgba(30, 34, 40, 0.95);
        border-color: rgba(255, 255, 255, 0.08);
    }
    
    body[data-theme="dark"] #custom-sidebar a {
        color: #a3afc3;
    }
    
    body[data-theme="dark"] #custom-sidebar a:hover {
        color: #fff;
    }
    `;
    document.head.appendChild(style);

    // 4. 读取数据
    fetch('data.json')
        .then(res => res.json())
        .then(data => {
            const menu = data['main-menu'];
            const ul = document.getElementById('sidebar-menu');
            if(menu) {
                Object.values(menu).forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${item.href}"><i class="${item.icon}"></i><span>${item.title}</span></a>`;
                    ul.appendChild(li);
                });
            }
        });

    // 5. 逻辑控制
    let sidebarVisible = false;
    let cachedSidebarWidth = 0; // 缓存宽度，避免重复计算 reflow

    function updateSidebarWidth() {
        const sidebar = document.getElementById('custom-sidebar');
        // 强制计算一次，存储起来
        cachedSidebarWidth = sidebar.offsetWidth;
    }

    function toggleSidebar() {
        sidebarVisible = !sidebarVisible;
        const sidebar = document.getElementById('custom-sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        
        // 如果没有缓存宽度（第一次点击），计算一次
        if (!cachedSidebarWidth) {
            updateSidebarWidth();
        }

        if (sidebarVisible) {
            sidebar.classList.add('sidebar-open');
            toggleBtn.classList.add('sidebar-open');
            // 使用 transform 移动按钮，不改变 left/top
            // 20px 是 sidebar 的 left 偏移量，-1px 是为了贴合
            const moveX = cachedSidebarWidth + 20 - 1; 
            // 保持 Y 轴居中 (-50%)
            toggleBtn.style.transform = `translate3d(${moveX}px, -50%, 0)`;
        } else {
            sidebar.classList.remove('sidebar-open');
            toggleBtn.classList.remove('sidebar-open');
            toggleBtn.style.transform = `translate3d(0, -50%, 0)`;
        }
    }

    // 初始化和事件绑定
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebar = document.getElementById('custom-sidebar');

        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });

        // 点击空白关闭
        document.addEventListener('click', function(e) {
            if (sidebarVisible && 
                !sidebar.contains(e.target) && 
                !toggleBtn.contains(e.target)) {
                toggleSidebar();
            }
        });
        
        // 窗口大小改变时重置缓存
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                updateSidebarWidth();
                if (sidebarVisible) {
                    // 如果是打开状态，需要修正按钮位置
                    const toggleBtn = document.getElementById('sidebar-toggle-btn');
                    const moveX = cachedSidebarWidth + 20 - 1;
                    toggleBtn.style.transform = `translate3d(${moveX}px, -50%, 0)`;
                }
            }, 200);
        });
    });
    
    // 移除旧版复杂的拖拽逻辑，因为拖拽和点击很容易冲突导致卡顿，
    // 且上下拖拽在移动端容易触发原生滚动，体验极差。
    // 如需拖拽，建议仅在PC端添加简单的 top 修改逻辑，但建议保持固定位置最流畅。
})();